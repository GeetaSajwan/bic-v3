<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Mocha Tests</title>

    <!-- mocha + chai + sinon-->
    <link rel="stylesheet" href="assets/mocha.css" />
    <script src="/bower_components/mocha/mocha.js"></script>
    <script src="/bower_components/chai/chai.js"></script>
    <script src="/bower_components/sinon-chai/lib/sinon-chai.js"></script>
    <script src="/bower_components/sinonjs/sinon.js"></script>

    <!-- global stuff-->
    <script src="/bower_components/jquery/jquery.min.js"></script>
    <script src="/bower_components/underscore/underscore-min.js"></script>
    <script src="/bower_components/backbone/backbone-min.js"></script>
    <script src="/bower_components/mustache/mustache.js"></script>
    <script src="/bower_components/requirejs/require.js"></script>
    <script src="/scripts/frag/00-config.js"></script>
    <script>
      require.config({
        paths: {
          feature: '/bower_components/amd-feature/feature',
          implementations: 'implementations',
          Squire: '/bower_components/squire/src/Squire'
        }
      });
      mocha.setup('bdd');
      var should = chai.should();
      var expect = chai.expect;

      window.BMP = {
        BIC: {
          siteVars: {
            answerSpace: 'Exists',
            answerSpaceId: 1
          }
        },
        FileInput: {
          initialize: function () {
              return "hello!";
          }
        }
      };
      window.Modernizr = {indexeddb: false};
      window.BlinkForms = {};
      Backbone.sync = function () {return arguments;}
      $.mobile = {
        loading: function () {},
        path: {
          parseUrl: function () {
            return {
              hrefNoSearch: "/test",
              search: ""
            }
          }
        },
        showPageLoadingMsg: function () {},
        pageLoadErrorMessageTheme: {},
        pageLoadErrorMessage: {}
      };
    </script>

    </head>
<body>
    <div id="mocha"></div>
    <script>
      require([
      'test-api.js',
      'test-collection-datasuitcases.js',
      'test-collection-forms.js',
      'test-collection-interactions.js',
      'test-collection-pending.js',
      'test-collection-stars.js',
//        'test-data.js',
      'test-model-application.js',
      'test-model-datasuitcase.js',
      'test-model-form.js',
      'test-model-interaction.js',
      'test-model-pending.js',
      'test-model-star.js',
      'test-router.js',
//        'test-view-interaction.js',
      'test-view-star.js'
      ], function () {
        var runner = mocha.run();

        var failedTests = [];
        runner.on('end', function(){
          window.mochaResults = runner.stats;
          window.mochaResults.reports = failedTests;
        });

        runner.on('fail', logFailure);

        function logFailure(test, err){

          var flattenTitles = function(test){
            var titles = [];
            while (test.parent.title){
              titles.push(test.parent.title);
              test = test.parent;
            }
            return titles.reverse();
          };

          failedTests.push({name: test.title, result: false, message: err.message, stack: err.stack, titles: flattenTitles(test) });
        };
      });
    </script>

</body>
</html>
