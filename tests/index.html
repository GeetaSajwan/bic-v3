<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Mocha Tests</title>

    <!-- mocha + chai + sinon-->
    <link rel="stylesheet" href="/bower_components/mocha/mocha.css" />
    <script src="/bower_components/mocha/mocha.js"></script>
    <script src="/bower_components/chai/chai.js"></script>
    <script src="/bower_components/sinon-chai/lib/sinon-chai.js"></script>
    <script src="/bower_components/sinonjs/sinon.js"></script>

    <!-- global stuff-->
    <script src="/bower_components/jquery/jquery.min.js"></script>
    <script src="/bower_components/underscore/underscore-min.js"></script>
    <script src="/bower_components/backbone/backbone-min.js"></script>
    <script src="/bower_components/mustache/mustache.js"></script>
    <script src="/bower_components/requirejs/require.js"></script>
    <script src="/scripts/frag/00-config.js"></script>
    <script>
      require.config({
        paths: {
          feature: '/bower_components/amd-feature/feature',
          implementations: 'implementations',
          Squire: '/bower_components/squire/src/Squire',
          pouchdb: '/bower_components/pouchdb/dist/pouchdb-nightly'
        }
      });
      mocha.setup('bdd');
      var should = chai.should();
      var expect = chai.expect;

      window.BMP = {
        BIC: {
          siteVars: {
            answerSpace: 'Exists',
            answerSpaceId: 1
          }
        },
        FileInput: {
          initialize: function () {
              return "hello!";
          }
        }
      };
      window.Modernizr = {indexeddb: false};
      window.BlinkForms = {};
      Backbone.sync = function (method, model, options) {
        var data, promise;
        data = model.data || model.collection.data;

        switch (method) {
        case "read":
          promise = model.id !== undefined ? data.read(model) : data.readAll();
          break;
        case "create":
          promise = data.create(model);
          break;
        case "update":
          promise = data.update(model);
          break;
        case "patch":
          promise = data.update(model);
          break;
        case "delete":
          promise = data['delete'](model);
          break;
        default:
          promise = Promise.reject(new Error('unknown method'));
        }

        promise.then(function (response) {
          if (options.success) {
            options.success(response);
          }
        }, function (response) {
          if (options.error) {
            options.error(response);
          }
        });

        model.trigger('request', model, promise, options);

        return promise;
      };
      $.mobile = {
        loading: function () {},
        path: {
          parseUrl: function () {
            return {
              hrefNoSearch: "/test",
              search: ""
            }
          }
        },
        showPageLoadingMsg: function () {},
        pageLoadErrorMessageTheme: {},
        pageLoadErrorMessage: {}
      };
    </script>

    </head>
<body>
    <div id="mocha"></div>
    <script>
      require([
      'feature!promises',
      'test-api.js',
      'test-collection-datasuitcases.js',
      'test-collection-forms.js',
      'test-collection-interactions.js',
      'test-collection-pending.js',
      'test-collection-stars.js',
      'test-data-pouch.js',
      'test-model-application.js',
      'test-model-datasuitcase.js',
      'test-model-form.js',
      'test-model-interaction.js',
      'test-model-pending.js',
      'test-model-star.js',
      'test-router.js',
      'test-view-interaction.js',
      'test-view-star.js'
      ], function (Promise) {
        if (!window.Promise) {
          window.Promise = Promise;
        }

        var runner = mocha.run();

        var failedTests = [];
        runner.on('end', function(){
          window.mochaResults = runner.stats;
          window.mochaResults.reports = failedTests;
        });

        runner.on('fail', logFailure);

        function logFailure(test, err){

          var flattenTitles = function(test){
            var titles = [];
            while (test.parent.title){
              titles.push(test.parent.title);
              test = test.parent;
            }
            return titles.reverse();
          };

          failedTests.push({name: test.title, result: false, message: err.message, stack: err.stack, titles: flattenTitles(test) });
        };
      });
    </script>

</body>
</html>
