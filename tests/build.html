<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Tests against Build</title>

    <!-- mocha + chai + sinon-->
    <link rel="stylesheet" href="assets/mocha.css" />
    <script src="assets/mocha.js"></script>
    <script src="assets/chai.js"></script>
    <script src="assets/sinon-chai.js"></script>
    <script src="assets/sinon.js"></script>

    <!-- global stuff-->
    <!--<script src="https://cdnp.blinkm.co/blink/require/6/require.min.js"></script>-->
    <script src="http://cdnp.blinkm.co/blink/require/6/require.min.js"></script>
    <script>
    window.Modernizr = {indexeddb: false};
    window.BMP = {
      BIC: {
        siteVars: {
          answerSpace: 'Exists',
          answerSpaceId: 1
        }
      },
      FileInput: {
        initialize: function () {
            return "hello!";
        }
      }
    };
    </script>
    <script src="../js/bic.js"></script>
</head>
<body>
  <div id="mocha"></div>
  <script>
    mocha.setup('bdd');
    mocha.globals([
      // Modernizr
      'Modernizr',
      'html5',
      'yepnope',
      'matchMedia',
      // everything else
      '$',
      'jQuery*',
      'moment',
      'BMP',
      '_',
      'Backbone'
    ]);
    var should = chai.should();
    var expect = chai.expect;

    require([
      'test-formsdeps.js',
    ], function () {
      var runner = mocha.run();

      var failedTests = [];
      runner.on('end', function(){
        window.mochaResults = runner.stats;
        window.mochaResults.reports = failedTests;
      });

      runner.on('fail', logFailure);

      function logFailure(test, err){

        var flattenTitles = function(test){
          var titles = [];
          while (test.parent.title){
            titles.push(test.parent.title);
            test = test.parent;
          }
          return titles.reverse();
        };

        failedTests.push({name: test.title, result: false, message: err.message, stack: err.stack, titles: flattenTitles(test) });
      };
    });
  </script>
</body>
</html>
