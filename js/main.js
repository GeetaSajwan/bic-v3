(function(){define("api-xhr",["jquery"],function(e){var t={getInteraction:function(t,n,i){var r="";return i&&e.each(i,function(e,t){r+="&"+e+"="+t}),e.ajax("/_BICv3_/xhr/GetInteraction.php?asn="+t+"&iact="+n+r)},getAnswerSpace:function(t){return e.ajax("/_BICv3_/xhr/GetApp.php?asn="+t)},getDataSuitcase:function(t,n){return e.ajax("/_BICv3_/xhr/GetDataSuitcase.php?asn="+t+"&ds="+n)},getForm:function(t,n){return e.ajax("/_BICv3_/xhr/GetForm.php?asn="+t+"&form="+n)}};return t}),define("data-pouch",["backbone","api-xhr","pouchdb","jquery"],function(e,t,n,i){var r={getModel:function(e,r){var a,o,s,c,l,u,d;a=function(e){r.success(e)},o=function(t){r.error&&r.error(e,t,r)},c=function(){switch(e.get("BICtype")){case"Interaction":s=t.getInteraction(e.get("siteName"),e.get("_id"),e.get("args")).done(a).fail(o);break;case"AnswerSpace":s=t.getAnswerSpace(e.get("siteName")).done(a).fail(o);break;case"DataSuitcase":s=t.getDataSuitcase(e.get("siteName"),e.get("_id")).done(a).fail(o);break;case"Form":s=t.getForm(e.get("siteName"),e.get("_id")).done(a).fail(o);break;default:r.error(e,null,r),s=null}s.then(function(e,t,n){r.dfrd.resolve(e,t,n)},function(e,t,n){r.dfrd.reject(e,t,n)})},l=window.NativeApp===!0&&n.adapters.websql?"websql://":n.adapters.idb?"idb://":!1,u=function(t,i){t.done(function(t){new n(l+e.get("siteName")+"-"+e.get("BICtype"),function(e,n){e||(new Date,i&&(t._rev=i),n.put(t,function(){}))})})},d=function(){var t,r=i.Deferred();return t=new n(l+e.get("siteName")+"-"+e.get("BICtype"),function(t,n){var i=new Date;t?r.reject(t):e.has("_id")?n.get(e.get("_id"),function(t,n){t?r.reject():0===n.deviceCacheTime?r.resolve(n):e.has("args")?r.reject("Interaction has arguments",n):i.getTime()-n.fetchTime<1e3*n.deviceCacheTime?r.resolve(n):r.reject("Interaction too old",n)}):r.reject()}),r.promise()},l!==!1?d().then(function(t){r.dfrd.resolve(t),r.success(e,t,r)},function(e,t){c();var n;t&&(n=t._rev),u(s,n)}):c()}};return e.sync=function(e,t,n){return n.dfrd=i.Deferred(),r.getModel(t,n),n.dfrd.promise()},e}),define("model-interaction-mobile",["data-pouch","jquery","underscore","jquerymobile"],function(e,t,n){var i=e.Model.extend({idAttribute:"_id",defaults:{header:null,content:null,footer:null,name:null},inherit:function(e){if(this.has("parent")){var t,i=require("model-application-mobile");n.each(this.attributes,function(t,i){n.has(e,i)&&e[i]||(e[i]=t)},this),"app"!==this.get("parent")?(t=i.interactions.get(this.get("parent")),t.inherit(e)):n.each(i.attributes,function(t,i){n.has(e,i)&&e[i]||(e[i]=t)},i)}return e},performXSLT:function(){var e,n,i,r,a,o,s,c,l,u,d,f;if(this.has("args"))for(s=this.get("args"),c=e.match(/\$args\[[\w\:][\w\:\-\.]*\]/g),l=c?c.length:0,e=this.get("xsl"),u=0;l>u;u+=1)d="string"==typeof s[c[u].substring(1)]?s[c[u].substring(1)]:"",d=d.replace('"',""),d=d.replace("'",""),d=decodeURIComponent(d),e=e.replace(c[u],d);else e=this.get("xsl");return f=require("model-application-mobile"),n=f.datasuitcases.where({name:this.get("xml")})[0].get("data"),i=e,"string"!=typeof n||"string"!=typeof i?(this.set("content","XSLT failed due to poorly formed XML or XSL."),void 0):(a=t.parseXML(n),e=t.parseXML(i),window.XSLTProcessor?(o=new window.XSLTProcessor,o.importStylesheet(e),r=o.transformToFragment(a,document)):r=void 0!==a.transformNode?a.transformNode(e):window.xsltProcess?window.xsltProcess(a,e):"<p>Your browser does not support Data Suitcase keywords.</p>",r&&this.set("content",r),void 0)}});return i}),define("collection-interactions-mobile",["backbone","model-interaction-mobile"],function(e,t){var n=e.Collection.extend({model:t,url:function(){return"/_BICv3_/xhr/GetInteraction.php?asn="+this.app.get("answerspace")}});return n}),define("model-datasuitcase-mobile",["data-pouch"],function(e){var t=e.Model.extend({idAttribute:"_id"});return t}),define("collection-datasuitcases-mobile",["backbone","model-datasuitcase-mobile"],function(e,t){var n=e.Collection.extend({model:t});return n}),define("model-form-mobile",["data-pouch","BlinkForms","underscore","jquery","model-application-mobile"],function(e,t,n,i,r){var a,o=e.Model.extend({idAttribute:"_id",initialize:function(){t.getDefinition=function(e,t){var a,o,s,c,l=r.forms.where({name:e})[0].get("definition"),u=i.Deferred();return a=function(e){var i=e.default||{};return t&&e[t]&&n.extend(i,e[t]),i},o={"default":{name:e}},n.isArray(l.default._elements)&&(o.default._elements=n.map(l.default._elements,a)),n.isArray(l.default._sections)&&(o.default._sections=n.map(l.default._sections,a)),n.isArray(l.default._pages)&&(o.default._pages=n.map(l.default._pages,a)),t||u.resolve(o.default),l[t]&&l[t]._elements&&(n.extend(o.default,l[t]),s=n.filter(s,function(e){return-1!==c.indexOf(e.default.name)}),s=n.sortBy(s,function(e){return c.indexOf(e.default.name)})),u.resolve(o.default),u.promise()}},getForm:function(e,n){return t.getDefinition(e,n).then(function(e){t.initialize(e)}),t.currentFormObject}});return a=new o}),define("collection-forms-mobile",["backbone","model-form-mobile"],function(e,t){var n=e.Collection.extend({model:t});return n}),define("model-application-mobile",["data-pouch","collection-interactions-mobile","collection-datasuitcases-mobile","model-datasuitcase-mobile","collection-forms-mobile","model-form-mobile","underscore"],function(e,t,n,i,r,a,o){var s,c=e.Model.extend({initialize:function(){this.interactions=new t,this.datasuitcases=new n,this.forms=new r,this.on("change",this.update)},idAttribute:"_id",update:function(){var e,t,n,r={DataSuitcases:this.datasuitcases,Forms:this.forms};o.each(r,function(r,o){if(this.has(o))for(e=this.get(o),t=0;e.length>t;t+=1)if(0===r.where({name:e[t]}).length){switch(o){case"DataSuitcases":n=new i({_id:e[t],siteName:this.get("siteName"),BICtype:"DataSuitcase"});break;case"Forms":n=new a({_id:e[t],siteName:this.get("siteName"),BICtype:"Form"})}r.add(n),n.fetch()}},this)}});return s=new c}),define("text",["module"],function(e){var t,n,i=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],r=/^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,a=/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,o="undefined"!=typeof location&&location.href,s=o&&location.protocol&&location.protocol.replace(/\:/,""),c=o&&location.hostname,l=o&&(location.port||void 0),u=[],d=e.config&&e.config()||{};return t={version:"2.0.3",strip:function(e){if(e){e=e.replace(r,"");var t=e.match(a);t&&(e=t[1])}else e="";return e},jsEscape:function(e){return e.replace(/(['\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r").replace(/[\u2028]/g,"\\u2028").replace(/[\u2029]/g,"\\u2029")},createXhr:d.createXhr||function(){var e,t,n;if("undefined"!=typeof XMLHttpRequest)return new XMLHttpRequest;if("undefined"!=typeof ActiveXObject)for(t=0;3>t;t+=1){n=i[t];try{e=new ActiveXObject(n)}catch(r){}if(e){i=[n];break}}return e},parseName:function(e){var t=!1,n=e.indexOf("."),i=e.substring(0,n),r=e.substring(n+1,e.length);return n=r.indexOf("!"),-1!==n&&(t=r.substring(n+1,r.length),t="strip"===t,r=r.substring(0,n)),{moduleName:i,ext:r,strip:t}},xdRegExp:/^((\w+)\:)?\/\/([^\/\\]+)/,useXhr:function(e,n,i,r){var a,o,s,c=t.xdRegExp.exec(e);return c?(a=c[2],o=c[3],o=o.split(":"),s=o[1],o=o[0],!(a&&a!==n||o&&o.toLowerCase()!==i.toLowerCase()||(s||o)&&s!==r)):!0},finishLoad:function(e,n,i,r){i=n?t.strip(i):i,d.isBuild&&(u[e]=i),r(i)},load:function(e,n,i,r){if(r.isBuild&&!r.inlineText)return i(),void 0;d.isBuild=r.isBuild;var a=t.parseName(e),u=a.moduleName+"."+a.ext,f=n.toUrl(u),m=d.useXhr||t.useXhr;!o||m(f,s,c,l)?t.get(f,function(n){t.finishLoad(e,a.strip,n,i)},function(e){i.error&&i.error(e)}):n([u],function(e){t.finishLoad(a.moduleName+"."+a.ext,a.strip,e,i)})},write:function(e,n,i){if(u.hasOwnProperty(n)){var r=t.jsEscape(u[n]);i.asModule(e+"!"+n,"define(function () { return '"+r+"';});\n")}},writeFile:function(e,n,i,r,a){var o=t.parseName(n),s=o.moduleName+"."+o.ext,c=i.toUrl(o.moduleName+"."+o.ext)+".js";t.load(s,i,function(){var n=function(e){return r(c,e)};n.asModule=function(e,t){return r.asModule(e,c,t)},t.write(e,s,n,a)},a)}},"node"===d.env||!d.env&&"undefined"!=typeof process&&process.versions&&process.versions.node?(n=require.nodeRequire("fs"),t.get=function(e,t){var i=n.readFileSync(e,"utf8");0===i.indexOf("ï»¿")&&(i=i.substring(1)),t(i)}):"xhr"===d.env||!d.env&&t.createXhr()?t.get=function(e,n,i){var r=t.createXhr();r.open("GET",e,!0),d.onXhr&&d.onXhr(r,e),r.onreadystatechange=function(){var t,a;4===r.readyState&&(t=r.status,t>399&&600>t?(a=Error(e+" HTTP status: "+t),a.xhr=r,i(a)):n(r.responseText))},r.send(null)}:("rhino"===d.env||!d.env&&"undefined"!=typeof Packages&&"undefined"!=typeof java)&&(t.get=function(e,t){var n,i,r="utf-8",a=new java.io.File(e),o=java.lang.System.getProperty("line.separator"),s=new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(a),r)),c="";try{for(n=new java.lang.StringBuffer,i=s.readLine(),i&&i.length()&&65279===i.charAt(0)&&(i=i.substring(1)),n.append(i);null!==(i=s.readLine());)n.append(o),n.append(i);c=""+n+""}finally{s.close()}t(c)}),t}),define("text!templates/interaction.html",[],function(){return'{{{header}}}\n<div data-role="content">\n    {{{content}}}\n</div>\n{{{footer}}}'}),define("text!templates/inputPrompt.html",[],function(){return'<form method="get">\n    {{{inputs}}}\n    <button type="submit" data-theme="a">Go</button>\n</form>\n'}),define("view-interaction-mobile",["jquery","backbone","mustache","text!templates/interaction.html","text!templates/inputPrompt.html","model-application-mobile","underscore","model-form-mobile","jquerymobile"],function(e,t,n,i,r,a,o,s){var c=t.View.extend({initialize:function(){e("body").append(this.$el)},events:{"click [keyword]":"blinklink","click [interaction]":"blinklink","click [category]":"blinklink","click [masterCategory]":"blinklink","click [back]":"back","click [home]":"blinklink","click [login]":"blinklink"},attributes:{"data-role":"page"},blinklink:function(t){t.preventDefault();var n,i,r,a,o="",s=!0;for(n="A"!==t.target.tagName?e(t.target).parents("a"):e(t.target),i="",n.attr("keyword")?i=n.attr("keyword"):n.attr("interaction")?i=n.attr("interaction"):n.attr("category")?i=n.attr("category"):n.attr("masterCategory")?i=n.attr("masterCategory"):n.attr("home")?i=this.get("siteName"):n.attr("login")&&(i=this.get("siteName")),r=0;n[0].attributes.length>r;r+=1)"_"===n[0].attributes[r].name.substr(0,1)&&(s?(s=!1,o="/?args["+n[0].attributes[r].name.substr(1)+"]="+n[0].attributes[r].value):o+="&args["+n[0].attributes[r].name+"]="+n[0].attributes[r].value);a=e.mobile.path.parseLocation().pathname,e.mobile.path.parseLocation().search&&(a=e.mobile.path.parseLocation().pathname.substr(0,e.mobile.path.parseLocation().pathname.length-1)),"/"===a.slice(-1)&&(a=a.slice(0,a.length-1)),e.mobile.changePage(a+"/"+i+o)},back:function(e){e.preventDefault(),history.back()},render:function(){var t,a,c,l=this.model.inherit({});return this.model.has("inputPrompt")&&!this.model.has("args")?(a=this.model.get("inputPrompt"),t="<form>"===a.substr(0,6)?a:n.render(r,{inputs:a}),this.$el.html(n.render(i,{header:l.header,footer:l.footer,content:t}))):this.model.has("type")&&"xslt"===this.model.get("type")?(this.model.performXSLT(),"object"==typeof this.model.get("content")&&(this.$el.html(n.render(i,{header:l.header,footer:l.footer,content:""})),this.$el.children("[data-role=content]")[0].appendChild(this.model.get("content")))):this.model.has("type")&&"form"===this.model.get("type")?(c=s.getForm(this.model.get("blinkFormObjectName"),this.model.get("blinkFormAction")),this.$el.html(n.render(i,{header:l.header,footer:l.footer,content:'<div id="BlinkForm"></div>'})),e("#BlinkForm").append(c.$form)):(o.has(l,"themeSwatch")&&this.$el.attr("data-theme",l.themeSwatch),this.$el.html(n.render(i,l)),this.maps()),this},maps:function(){var e=this.$el.find("[class=googlemap]");0!==e.length&&(this.$el.append('<style type="text/css">.googlemap { width: 100%; height: 360px; }</style>'),this.$el.append('<script src="/_BICv3_/js/gMaps.js"></script>'))}});return c}),define("router-mobile",["backbone","model-application-mobile","model-interaction-mobile","view-interaction-mobile","jquery","jquerymobile"],function(e,t,n,i,r){var a=e.Router.extend({initialize:function(){t.router=this,r(document).on("pagebeforeload",function(e,n){e.preventDefault(),r.mobile.loading("show"),t.router.processPath(n)})},processPath:function(e){var n,i,a,o,s,c,l=e.dataUrl.substr(1).split("/"),u="app",d=[];if(""===l[l.length-1]&&l.pop(),1===l.length?(t.has("homeScreen")&&t.get("homeScreen")===!0?(n=t.get("siteName"),i=t.get("homeInteraction"),a=""):(n=t.get("siteName"),i=t.get("siteName"),a=""),l=[]):(n=l.shift(),o=l.pop(),o&&-1!==o.indexOf("?")&&0!==o.indexOf("?")?(s=o.split("?"),a=this.assembleArgs(s.pop()),i=s.pop()):o&&-1!==o.indexOf("?")&&0===o.indexOf("?")?(i=l.pop(),a=this.assembleArgs(o.slice(1))):(a=null,i=o)),l.length>0)for(c=0;l.length>c;c+=1)d.push(t.router.loadInteraction(l[c],null,u)),u=l[c];r.when.apply(r,d).then(function(){t.router.loadInteraction(i,a,u,t.router.displayInteraction(e))})},assembleArgs:function(e){var t=e.split("&"),n={};return r.each(t,function(e,t){var i,r,a;0!==t.length&&-1!==(i=t.indexOf("="))&&(r=t.substring(0,i),a=t.substring(i+1),a&&(n[decodeURIComponent(r)]=decodeURIComponent(a)))}),n},loadInteraction:function(e,n,i,a){var o,s;return t.interactions.get(e)?("madl code"===t.interactions.get(e).get("type")&&a?s=t.interactions.get(e).fetch(a):(o=r.Deferred(),s=o.promise(),a&&a.success(t.interactions.get(e),"Collection",a),o.resolve()),t.interactions.get(e).set("parent",i)):(t.interactions.add({_id:e,name:e,parent:i,siteName:t.get("siteName"),BICtype:"Interaction",args:n}),s=t.interactions.get(e).fetch(a)),s},displayInteraction:function(e){return{success:function(e,t,n){var a=new i({tagName:"div",model:e}).render();a.$el.attr("data-url",n.data.dataUrl),a.$el.attr("data-external-page",!0),a.$el.one("pagecreate",r.mobile._bindPageRemove),n.data.deferred.resolve(n.data.absUrl,n.data.options,a.$el)},error:function(e,t,n){n.data.deferred.reject(n.data.absUrl,n.data.options),r.mobile.showPageLoadingMsg(r.mobile.pageLoadErrorMessageTheme,r.mobile.pageLoadErrorMessage,!0),setTimeout(r.mobile.hidePageLoadingMsg,1500)},data:e,app:t}}});return new a}),requirejs.config({baseUrl:"/_BICv3_/scripts",paths:{BlinkForms:["/_BICv3_/js/BlinkForms.min"],pouchdb:["/_BICv3_/js/pouchdb-nightly"]},shim:{BlinkForms:{exports:"BlinkForms"},pouchdb:{exports:"Pouch"}}}),define("main",["backbone","router-mobile","model-interaction-mobile","view-interaction-mobile","model-application-mobile","jquery","jquerymobile"],function(e,t,n,i,r,a){var o=function(){var e=a.mobile.path.parseLocation();r.set({_id:e.pathname.substr(1).split("/")[0],siteName:e.pathname.substr(1).split("/")[0],BICtype:"AnswerSpace"}).fetch({success:function(t){a.mobile.defaultPageTransition=t.get("defaultTransition"),a.mobile.changePage(e.pathname,{changeHash:!1,reloadPage:!0,transition:"fade"}),a(document).on("pageshow",function(){a("#temp").remove()})}})},s=function(){window.NativeApp===!0?cordova.available===!0?o():window.setTimeout(s(),1e3):o()};s()})})();
//@ sourceMappingURL=main.js.map